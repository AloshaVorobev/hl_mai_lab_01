# Лабораторные работы №1-4 (Управление IT-проектами) #

Выполнил: Воробьев Алексей, М8О-103М-20

## Сборка проекта ##

```bash
mkdir -p CMakeFiles
cd CMakeFiles
cmake configure ..
cd ..
cmake --build ./CMakeFiles
```

## Запуск Docker-окружения ##

```bash
sudo docker-compose up -d
```

## Создание скрипта для заполнения шардов ##

Искуственно сгенерированный датасет, использовавшийся в лабораторных работах 1 и 2, необходимо разделить на 3 запроса для каждого из шардов:

```bash
CMakeFiles/./data_shard_splitter
```

Данный исполняемый файл генерирует скрипт shard_fill.sql.

## Настройка базы данных ##

1. Создание таблицы Person на каждом из трех шардов.
2. Заполнение базы данных с помощью сгенерированного скрипта.

```bash
mysql -u test -p pzjqUkMnc7vfNHET -h 127.0.0.1 -P 6033 --comments
mysql> source db_scripts/shard_init.sql;
mysql> source db_scripts/shard_fill.sql;
```

Удаление данных с узлов выполняется с помощью следующей команды:

```bash
mysql> source db_scripts/shard_cleanup.sql;
```

Удаление таблиц на шардах выполняется с помощью следующей команды:

```bash
mysql> source db_scripts/shard_drop.sql;
```

## Запуск сервера ##

Для запуска сервера следует выполнить команду:

```bash
sudo sh ./start.sh
```

Сервер работает на порту 8080.

## Запуск подписчика для очереди ##

Для запуска подписчика, читающего сообщения с очереди, следует выполнить команду:

```bash
sudo sh ./start_writer.sh
```

## Модульное тестирование (GTests) ##

Запуск модульных тестов осуществляется следующей командой:

```bash
./CMakeFiles/gtests
```

Для тестирования используется исходная таблица Person с последующей очисткой данных в каждом шарде по окончании работы gtests.

## Нагрузочное тестирование (wrk) ##

Нагрузочное тестирование производилось для 1, 2, 6 и 10 потоков при 50 подключениях в течение 30 секунд.
Были проведены тесты как на чтение данных, так и на их запись с помощью .lua-файла, передаваемого в качестве аргумента для wrk.

Запуск тестов (следует проводить при работе сервера и подписчика):

```bash
sudo sh ./tests.sh
```

- Threads - количество потоков;
- Requests/sec - количество запросов в секунду;
- Latency(ms) - задержка в миллисекундах.

Запись с использованием очереди:

Threads | Requests/sec   | Latency(ms)
---     | ---            | ---
1       | 71.73          | 209.63
2       | 55.43          | 279.15
6       | 60.76          | 255.90
10      | 55.31          | 277.19

Запись без использования очереди:

Threads | Requests/sec   | Latency(ms)
---     | ---            | ---
1       | 36.23          | 430.31
2       | 40.89          | 398.82
6       | 39.11          | 383.18
10      | 39.78          | 401.36

Чтение с использованием кэша:

Threads | Requests/sec   | Latency(ms)
---     | ---            | ---
1       | 77.85          | 276.49
2       | 82.33          | 206.60
6       | 27.34          | 292.08
10      | 12.51          | 339.97

Чтение без использования кэша:

Threads | Requests/sec | Latency(ms)
---     | ---          | ---
1       | 169.13       | 94.86
2       | 93.24        | 87.64
6       | 45.44        | 88.82
10      | 44.55        | 90.84

## Очистка таблиц после нагрузочного тестирования ##

Для очистки таблиц шардов после нагрузочного тестирования необходимо выполнить следующие команды:

```bash
mysql -u test -p pzjqUkMnc7vfNHET -h 127.0.0.1 -P 6033 --comments
mysql> source db_scripts/shard_test_cleanup.sql;
```

## Остановка работы Docker-окружения ##

```bash
sudo docker-compose stop
```
